# UI Test Job

jobs: 
  - job: CallingAutomatedUITest
    displayName: "Calling Automated UI Tests"
    pool:
      name: vsts-mac-1301-xcode-141
      demands: xcode

    variables:
      - group: 'SPOOL-Communication-mobileUI'
      - name: 'acsDisplayName'
        value: 'iOS CI UI Automated Tester'
      - name: 'ACSFreshToken'
        value: ''

    steps:
      - task: servicetree-link-build-task@1
        displayName: "ServiceTree: [$(BuildOutputUsage)] "
        inputs:
          ServiceTreeGateway: "ServiceTree Gateway"
          Service: "e38fcba7-191b-47ad-bb71-aeff7c983e3f"
        condition: always()
      
      - template: templates/retrieve-acs-token.yml

      - task: CocoaPods@0
        displayName: 'pod install'
        inputs:
          workingDirectory: AzureCommunicationUI
          forceRepoUpdate: true
          projectDirectory: AzureCommunicationUI

      - script: |
          export INFO_PLIST_FILE=$(system.defaultWorkingDirectory)/AzureCommunicationUI/AzureCommunicationUIDemoApp/Sources/Info.plist
          
          plutil -replace groupCallId -string "$(groupCallId)" $INFO_PLIST_FILE
          plutil -replace teamsMeetingLink -string "$(teamsMeetingLink)" $INFO_PLIST_FILE
          plutil -replace displayName -string "$(acsDisplayName)" $INFO_PLIST_FILE
          plutil -replace acsTokenUrl -string "$(acsTokenUrl)" $INFO_PLIST_FILE
          plutil -replace expiredAcsToken -string "$(expiredAcsToken)" $INFO_PLIST_FILE
          plutil -replace acsToken -string "$(ACSFreshToken)" $INFO_PLIST_FILE
          plutil -replace aadToken -string "$(AADToken)" $INFO_PLIST_FILE

        displayName: 'Edit AzureCommunicationUIDemoApp Info.plist'

      - script: |
          export INFO_PLIST_FILE=$(system.defaultWorkingDirectory)/AzureCommunicationUI/AzureCommunicationUIDemoApp/Tests/Info.plist
          plutil -replace expiredAcsToken -string "$(expiredAcsToken)" $INFO_PLIST_FILE

        displayName: 'Edit AzureCommunicationUIDemoAppUITests Info.plist'

      - task: Xcode@5
        displayName: 'Xcode build'
        inputs:
          configuration: Release
          sdk: iphoneos
          xcWorkspacePath: AzureCommunicationUI/AzureCommunicationUI.xcworkspace
          scheme: AzureCommunicationUICalling
          xcodeVersion: default

      - task: Xcode@5
        displayName: 'Xcode Demo UI test'
        inputs:
          actions: test
          configuration: Debug
          sdk: iphoneos
          xcWorkspacePath: AzureCommunicationUI/AzureCommunicationUI.xcworkspace
          scheme: AzureCommunicationUIDemoApp
          xcodeVersion: default
          destinationPlatformOption: iOS
          destinationSimulators: 'iPhone 14 Pro'
          args: '-verbose'
          publishJUnitResults: true

