# Configures which target to use for AppCenter tests based on type of build and day of week


steps:
  - bash: |
      #!/bin/bash
      echo "Start: $(pipeline.startTime)"
      
      # if [[ "$(Build.Reason)" != "Scheduled" ]]; then
      #   # If not scheduled, use AppCenterDevices variable if set, otherwise default device set
      #   if [ -z "${APPCENTER_DEVICES}" ]; then
      #     echo "Non-scheduled, no AppCenter device set specified. Setting defaults"
      #     echo "##vso[task.setvariable variable=AppCenterDevices]Azure-Communication-Services/defaults"  
      #   fi
      #   exit 0
      # fi

      # If scheduled, use the schedule defined IN UTC TIME AS PER ADO CRON SCHEDULES

      echo "Server Day is $UTC_DAY_OF_WEEK, server HOUR is $UTC_HOUR_OF_DAY"
      echo "${"
      case $UTC_DAY_OF_WEEK in 

        Monday)
          case $UTC_HOUR_OF_DAY in
            00)
              APPCENTER_DEVICES=ipadpro11set
              ;;
            02)
              APPCENTER_DEVICES=ipadpro12set
              ;;
            08)
              APPCENTER_DEVICES=iphone11promaxset
              ;;
            10)
              APPCENTER_DEVICES=iphone11proset
              ;;
            12)
              APPCENTER_DEVICES=iphone11set
              ;;
          esac
          ;;

        Tuesday)
          case UTC_HOUR_OF_DAY in
            00)
              APPCENTER_DEVICES=ipadairset
              ;;
            02)
              APPCENTER_DEVICES=ipadminiset
              ;;
            08)
              APPCENTER_DEVICES=iphone12promaxset
              ;;
            10)
              APPCENTER_DEVICES=iphone12proset
              ;;
            12)
              APPCENTER_DEVICES=iphone12set
              ;;
          esac
          ;;

        Wednesday)
          case UTC_HOUR_OF_DAY in
            00)
              APPCENTER_DEVICES=ipadpro10set
              ;;
            02)
              APPCENTER_DEVICES=ipadpro11set
              ;;
            08)
              APPCENTER_DEVICES=iphone13promaxset
              ;;
            10)
              APPCENTER_DEVICES=iphone13proset
              ;;
            12)
              APPCENTER_DEVICES=iphone13set
              ;;
          esac
          ;;

        Thursday)
          case UTC_HOUR_OF_DAY in
            00)
              APPCENTER_DEVICES=ipadpro12set
              ;;
            08)
              APPCENTER_DEVICES=iphone7plusset
              ;;
            10)
              APPCENTER_DEVICES=iphone7set
              ;;
            12)
              APPCENTER_DEVICES=iphone8plusset
              ;;
            14)
              APPCENTER_DEVICES=iphone8set
              ;;
          esac
          ;;

        Friday)
          case UTC_HOUR_OF_DAY in
            08)
              APPCENTER_DEVICES=iphoneseset
              ;;
            10)
              APPCENTER_DEVICES=iphonexrset
              ;;
            12)
              APPCENTER_DEVICES=iphonexrmaxset
              ;;
            14)
              APPCENTER_DEVICES=iphonexsset
              ;;
          esac
          ;;

        Saturday)
          case UTC_HOUR_OF_DAY in
            08)
              APPCENTER_DEVICES=iphone11promaxset
              ;;
            10)
              APPCENTER_DEVICES=iphone11proset
              ;;
            12)
              APPCENTER_DEVICES=iphone11set
              ;;
            14)
              APPCENTER_DEVICES=iphone12promaxset
              ;;
            16)
              APPCENTER_DEVICES=iphone12proset
              ;;
            18)
              APPCENTER_DEVICES=iphone12set
              ;;
            20)
              APPCENTER_DEVICES=iphone13promaxset
              ;;
            22)
              APPCENTER_DEVICES=iphone13proset
              ;;
          esac
          ;;  

        Sunday)
          case UTC_HOUR_OF_DAY in
            00)
              APPCENTER_DEVICES=iphone13set
              ;;
            02)
              APPCENTER_DEVICES=iphone7plusset
              ;;
            04)
              APPCENTER_DEVICES=iphone7set
              ;;
            06)
              APPCENTER_DEVICES=iphone8plusset
              ;;
            08)
              APPCENTER_DEVICES=iphone8set
              ;;
            10)
              APPCENTER_DEVICES=iphoneseset
              ;;
            12)
              APPCENTER_DEVICES=iphonexrset
              ;;
            14)
              APPCENTER_DEVICES=iphonexsmaxset
              ;;
            16)
              APPCENTER_DEVICES=iphonexsset
              ;;
            18)
              APPCENTER_DEVICES=ipadairset
              ;;
            20)
              APPCENTER_DEVICES=ipadminiset
              ;;
            22)
              APPCENTER_DEVICES=ipadpro10set
              ;;
          esac
          ;;
      esac

      if [[ -z "${APPCENTER_DEVICES}" ]]; then
        echo "No scheduled run for this time / day combination"
      else 
         echo "##vso[task.setvariable variable=AppCenterDevices]Azure-Communication-Services/$APPCENTER_DEVICES"
      fi

    displayName: 'Set AppCenterDevices variable based on calling'
    env:
      APPCENTER_DEVICES: $(AppCenterDevices)
      UTC_DAY_OF_WEEK: $[format('{0:A}', pipeline.startTime)]
      UTC_HOUR_OF_DAY: $[format('{0:HH}', pipeline.startTime)]

